name: VHDL practice exercises CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    name: VHDL exercises tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install NVC
        uses: nickg/setup-nvc@v1
        with:
          version: latest

      - name: üß™ Run VHDL tests for all practice exercises
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob
          for d in */; do
            folder_name=${d%/}
            echo "üß™ Testing $folder_name"
              nvc -a "$d"/*.vhd || { 
                echo "‚ùå Analysis failed in $folder_name"
                rm -rf work
                exit 1
              }
              shopt -s nullglob

              tbfiles=( "$d"/*_tb.vhd )
              if (( ${#tbfiles[@]} == 0 )); then
                echo "‚ùå No testbench found in $folder_name"
                rm -rf work
                exit 1
              fi

              tbname=$(basename "${tbfiles[0]}" .vhd)
              nvc -e "$tbname" || { 
                echo "‚ùå Elaboration failed for $tbname in $folder_name"
                rm -rf work
                exit 1 
              }
              nvc -r "$tbname" --exit-severity=error || {
                echo "‚ùå Simulation failed for $tbname in $folder_name"
                rm -rf work
                exit 1
              }
            echo "‚úÖ $folder_name passed"
          done
          echo "‚úÖ All tests passed!"
